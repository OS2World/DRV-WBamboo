Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 1
bamboo.asm



      1					 .486p
      2	00000000			 model flat
      3					 ideal
      4
      5					 ; screen size
      6		  =0500			 xMaxScreen=1280
      7		  =0320			 yMaxScreen=800
      8
      9					 extrn DosClose:near
     10					 extrn DosCreateThread:near
     11					 extrn DosExit:near
     12					 extrn DosExitList:near
     13					 extrn DosOpen:near
     14					 extrn DosSetPriority:near
     15					 extrn DosSleep:near
     16					 extrn DosSuspendThread:near
     17					 extrn DosWrite:near
     18
     19	00000000			 stack 8192
     20
     21	00002000			 dataseg
     22	00000000  5C 44	45 56 5C 58 53+	 szScreen db '\DEV\XSMOUSE$',0
     23		  4D 4F	55 53 45 24 00
     24	0000000E  5C 44	45 56 5C 24 42+	 szTablet db '\DEV\$BAMBOO$',0
     25		  41 4D	42 4F 4F 24 00
     26
     27	0000001C			 udataseg
     28	00000000  ????????		 ActionTaken dd	?
     29	00000004  ????????		 BytesDone dd ?
     30	00000008  ????????		 fhScreen dd ?
     31	0000000C  ????????		 fhTablet dd ?
     32
     33	00000010			 udataseg
     34	00000010  ????????		 tidTablet dd ?
     35
     36	00000014			 codeseg
     37	00000000			 proc MainRoutine c near
     38					 arg @@Mod,@@Nul,@@Env,@@Arg
     39					 ; determine begin of arguments
1    40	00000000  C8 0000 00			 ENTERD	 00000h,0
1    41	00000004  FC			   cld ; operate foreward scan
     42	00000005  B9 00000200		   mov ecx,512 ; max scan length
     43	0000000A  8B 7D	14		   mov edi,[@@Arg] ; start address
     44	0000000D  F2> AE		   repne scasb ; find terminator
     45					 ; process passed arguments
     46	0000000F  BB 000000AAr		   mov ebx,offset(PutFingerEvent)
     47	00000014  B9 00000172r		   mov ecx,offset(PutStylusEvent)
     48	00000019  BE 00000063r		   mov esi,offset(PutScreenEvent)
     49	0000001E  E8 00000533		   call	ProcessArguments
     50					 ; open	tablet device driver
     51					   call	DosOpen	c,offset(szTablet),offset(fhTablet),offset(ActionTaken),0,0,1,0192h,0
1    52	00000023  6A 00				 PUSH	 0
1    53	00000025  68 00000192			 PUSH	 0192H
1    54	0000002A  6A 01				 PUSH	 1
1    55	0000002C  6A 00				 PUSH	 0
1    56	0000002E  6A 00				 PUSH	 0
1    57	00000030  68 00000000r			 PUSH	 OFFSET(ACTIONTAKEN)
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 2
bamboo.asm



1    58	00000035  68 0000000Cr			 PUSH	 OFFSET(FHTABLET)
1    59	0000003A  68 0000000Er			 PUSH	 OFFSET(SZTABLET)
1    60	0000003F  E8 00000000e			 CALL	 DOSOPEN
1    61	00000044  83 C4	20			 ADD	 ESP,00020h
     62	00000047  85 C0			   test	eax,eax	; success
     63	00000049  0F 85	00000084	   jnz NotOpenTabletDriver
     64					 ; open	screen device driver
     65					   call	DosOpen	c,offset(szScreen),offset(fhScreen),offset(ActionTaken),0,0,1,0192h,0
1    66	0000004F  6A 00				 PUSH	 0
1    67	00000051  68 00000192			 PUSH	 0192H
1    68	00000056  6A 01				 PUSH	 1
1    69	00000058  6A 00				 PUSH	 0
1    70	0000005A  6A 00				 PUSH	 0
1    71	0000005C  68 00000000r			 PUSH	 OFFSET(ACTIONTAKEN)
1    72	00000061  68 00000008r			 PUSH	 OFFSET(FHSCREEN)
1    73	00000066  68 00000000r			 PUSH	 OFFSET(SZSCREEN)
1    74	0000006B  E8 00000000e			 CALL	 DOSOPEN
1    75	00000070  83 C4	20			 ADD	 ESP,00020h
     76	00000073  85 C0			   test	eax,eax	; success
     77	00000075  75 4E			   jnz NotOpenScreenDriver
     78					 ; register termination	processing
     79					   call	DosExitList c,1,offset(ProcessComplete)
1    80	00000077  68 000000DFr			 PUSH	 OFFSET(PROCESSCOMPLETE)
1    81	0000007C  6A 01				 PUSH	 1
1    82	0000007E  E8 00000000e			 CALL	 DOSEXITLIST
1    83	00000083  83 C4	08			 ADD	 ESP,00008h
     84					 ; move	cursor to center of screen
     85					   call	DosWrite c,[fhScreen],esi,10,offset(BytesDone)
1    86	00000086  68 00000004r			 PUSH	 OFFSET(BYTESDONE)
1    87	0000008B  6A 0A				 PUSH	 10
1    88	0000008D  56				 PUSH	 ESI
1    89	0000008E  FF 35	00000008r		 PUSH	 [FHSCREEN]
1    90	00000094  E8 00000000e			 CALL	 DOSWRITE
1    91	00000099  83 C4	10			 ADD	 ESP,00010h
     92					 ; start tablet	input thread
     93					   call	DosCreateThread	c,offset(tidTablet),offset(TabletThread),0,2,8192
1    94	0000009C  68 00002000			 PUSH	 8192
1    95	000000A1  6A 02				 PUSH	 2
1    96	000000A3  6A 00				 PUSH	 0
1    97	000000A5  68 00000119r			 PUSH	 OFFSET(TABLETTHREAD)
1    98	000000AA  68 00000010r			 PUSH	 OFFSET(TIDTABLET)
1    99	000000AF  E8 00000000e			 CALL	 DOSCREATETHREAD
1   100	000000B4  83 C4	14			 ADD	 ESP,00014h
    101					 ; hang	in here	forever
    102					   call	DosSleep c,-1
1   103	000000B7  6A FF				 PUSH	 -1
1   104	000000B9  E8 00000000e			 CALL	 DOSSLEEP
1   105	000000BE  83 C4	04			 ADD	 ESP,00004h
    106	000000C1			 label EndProcess near
    107					 ; force process complete
    108	000000C1  2B C0			   sub eax,eax ; success
1   109	000000C3  C9				 LEAVED
1   110	000000C4  C3				 RET	 00000h
    111	000000C5			 label NotOpenScreenDriver near
    112					 ; close tablet	device driver
    113					   call	DosClose c,[fhTablet]
1   114	000000C5  FF 35	0000000Cr		 PUSH	 [FHTABLET]
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 3
bamboo.asm



1   115	000000CB  E8 00000000e			 CALL	 DOSCLOSE
1   116	000000D0  83 C4	04			 ADD	 ESP,00004h
    117	000000D3			 label NotOpenTabletDriver near
    118					 ; exit	the process
    119					   call	DosExit	c,1,0
1   120	000000D3  6A 00				 PUSH	 0
1   121	000000D5  6A 01				 PUSH	 1
1   122	000000D7  E8 00000000e			 CALL	 DOSEXIT
1   123	000000DC  83 C4	08			 ADD	 ESP,00008h
    124	000000DF			 endp MainRoutine
    125
    126	000000DF			 codeseg
    127	000000DF			 proc ProcessComplete c	near
    128					 arg @@ReasonCode
    129					 ; suspend tablet input	thread
1   130	000000DF  C8 0000 00			 ENTERD	 00000h,0
1   131					   call	DosSuspendThread c,[tidTablet]
2   132	000000E3  FF 35	00000010r		 PUSH	 [TIDTABLET]
2   133	000000E9  E8 00000000e			 CALL	 DOSSUSPENDTHREAD
2   134	000000EE  83 C4	04			 ADD	 ESP,00004h
    135					 ; close screen	device driver
    136					   call	DosClose c,[fhScreen]
1   137	000000F1  FF 35	00000008r		 PUSH	 [FHSCREEN]
1   138	000000F7  E8 00000000e			 CALL	 DOSCLOSE
1   139	000000FC  83 C4	04			 ADD	 ESP,00004h
    140					 ; close tablet	device driver
    141					   call	DosClose c,[fhTablet]
1   142	000000FF  FF 35	0000000Cr		 PUSH	 [FHTABLET]
1   143	00000105  E8 00000000e			 CALL	 DOSCLOSE
1   144	0000010A  83 C4	04			 ADD	 ESP,00004h
    145					 ; exit	termination process
    146					   call	DosExitList c,3,0)
1   147	0000010D  6A 00				 PUSH	 0
1   148	0000010F  6A 03				 PUSH	 3
1   149	00000111  E8 00000000e			 CALL	 DOSEXITLIST
1   150	00000116  83 C4	08			 ADD	 ESP,00008h
    151	00000119			 endp ProcessComplete
    152
    153	00000119			 dataseg
    154	0000001C  00			 SelectTouch db	0
    155
    156	0000001D			 codeseg
    157	00000119			 proc TabletThread c near
    158					 arg @@parameter:dword
    159					 ; set time critical priority
1   160	00000119  C8 0000 00			 ENTERD	 00000h,0
1   161					   call	DosSetPriority c,2,3,31,0
2   162	0000011D  6A 00				 PUSH	 0
2   163	0000011F  6A 1F				 PUSH	 31
2   164	00000121  6A 03				 PUSH	 3
2   165	00000123  6A 02				 PUSH	 2
2   166	00000125  E8 00000000e			 CALL	 DOSSETPRIORITY
2   167	0000012A  83 C4	10			 ADD	 ESP,00010h
    168					 ; start stylus	input process
    169	0000012D  80 3D	0000001Cr 01	   cmp [SelectTouch],1 ; touch
    170	00000134  0F 85	00000338	   jne StylusProcess ; stylus
    171	0000013A  E9 00000261		   jmp FingerProcess ; finger
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 4
bamboo.asm



    172	0000013F			 label BadTabletThread near
    173					 ; exit	the tablet thread
    174					   call	DosExit	c,0,0
1   175	0000013F  6A 00				 PUSH	 0
1   176	00000141  6A 00				 PUSH	 0
1   177	00000143  E8 00000000e			 CALL	 DOSEXIT
1   178	00000148  83 C4	08			 ADD	 ESP,00008h
    179	0000014B			 endp TabletThread
    180
    181	0000014B			 struc tbl
    182					 ; common tablet buffer
    183	00000000  01*(00)		 EvntBt0 db 0 ;	event flags
    184	00000001  01*(00)		 EvntBt1 db 0 ;	event flags
    185	00000002  01*(00)		 EvntBt2 db 0 ;	event flags
    186	00000003  01*(00)		 EvntBt3 db 0 ;	event flags
    187	00000004  01*(????????)		 xMaxPos dd ? ;	tablet width
    188	00000008  01*(????????)		 yMaxPos dd ? ;	tablet height
    189	0000000C  01*(00000500)		 xMaxOut dd xMaxScreen ; width
    190	00000010  01*(00000320)		 yMaxOut dd yMaxScreen ; height
    191	00000014  01*(00000000)		 xMinOut dd 0 ;	horizontal offset
    192	00000018  01*(00000000)		 yMinOut dd 0 ;	vertical offset
    193	0000001C  01*(00000000)		 xNewPos dd 0 ;	new position
    194	00000020  01*(00000000)		 yNewPos dd 0 ;	new position
    195	00000024  01*(00000000)		 xOldPos dd 0 ;	old position
    196	00000028  01*(00000000)		 yOldPos dd 0 ;	old position
    197					 ; mouse events	left/right
    198	0000002C  01*(1806)		 Button1 dw 1806h ; 010/001
    199	0000002E  01*(0618)		 Button2 dw 0618h ; 001/010
    200	00000030  01*(6060)		 Button3 dw 6060h ; 100/100
    201					 ; set maximum positions
    202	00000032  01*(????)		 xMax0 dw ? ; width
    203	00000034  01*(????)		 yMax0 dw ? ; height
    204	00000036  01*(????)		 xMax1 dw ? ; width
    205	00000038  01*(????)		 yMax1 dw ? ; height
    206	0000003A			 ends tbl
    207
    208	0000014B			 proc MouseActions near
    209					 ; set mouse button event
    210	0000014B  A8 07			   test	al,07h ; buttons
    211	0000014D  B4 01			   mov ah,001h ; MoveOnly
    212	0000014F  74 20			   jz EndButtons ; none
    213	00000151  B4 00			   mov ah,000h ; NoButMov
    214					 ; left/right handed mouse
    215	00000153  0F B6	15 00000062r	   movzx edx,[ButtonMode]
    216	0000015A  03 D7			   add edx,edi ; left/right
    217					 ; check 1st physical button
    218	0000015C  A8 01			   test	al,01h ; 1st button
    219	0000015E  74 03			   jz EndButton1 ; nope
    220					 ; apply 1st logical button
    221	00000160  0A 62	2C		   or ah,[byte(edx+tbl.Button1)]
    222	00000163			 label EndButton1 near
    223					 ; check 2nd physical button
    224	00000163  A8 02			   test	al,02h ; 2nd button
    225	00000165  74 03			   jz EndButton2 ; nope
    226					 ; apply 2nd logical button
    227	00000167  0A 62	2E		   or ah,[byte(edx+tbl.Button2)]
    228	0000016A			 label EndButton2 near
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 5
bamboo.asm



    229					 ; check 3rd physical button
    230	0000016A  A8 04			   test	al,04h ; 3rd button
    231	0000016C  74 03			   jz EndButton3 ; nope
    232					 ; apply 3rd logical button
    233	0000016E  0A 62	30		   or ah,[byte(edx+tbl.Button3)]
    234	00000171			 label EndButton3 near
    235	00000171			 label EndButtons near
    236					 ; return to caller
    237	00000171  C3			   ret ; return
    238	00000172			 endp MouseActions
    239
    240	00000172			 struc scr
    241					 ; common event	buffer
    242	00000000  01*(0001)		 BtnEvnt dw 1 ;	move to	center
    243	00000002  01*(0190)		 yCurPos dw yMaxScreen/2 ; center
    244	00000004  01*(0280)		 xCurPos dw xMaxScreen/2 ; center
    245	00000006  01*(0320)		 yMaxPos dw yMaxScreen ; height
    246	00000008  01*(0500)		 xMaxPos dw xMaxScreen ; width
    247	0000000A  01*(00000500)		 xMaxOut dd xMaxScreen ; width
    248	0000000E  01*(00000320)		 yMaxOut dd yMaxScreen ; height
    249	00000012  01*(00000280)		 xOutPos dd xMaxScreen/2 ; center
    250	00000016  01*(00000190)		 yOutPos dd yMaxScreen/2 ; center
    251					 ; set mouse events left/right
    252	0000001A  01*(0101)		 Action0 dw 0101h ; 000/000
    253	0000001C  01*(1806)		 Action1 dw 1806h ; 010/001
    254	0000001E  01*(0618)		 Action2 dw 0618h ; 001/010
    255	00000020  01*(1E1E)		 Action3 dw 1E1Eh ; 011/011
    256	00000022  01*(6060)		 Action4 dw 6060h ; 100/100
    257	00000024  01*(7866)		 Action5 dw 7866h ; 101/011
    258	00000026  01*(6678)		 Action6 dw 6678h ; 011/101
    259	00000028  01*(7E7E)		 Action7 dw 7E7Eh ; 111/111
    260	0000002A			 ends scr
    261
    262	00000172			 dataseg
    263	0000001D  00			 CircleMode db 0
    264
    265	0000001E			 codeseg
    266	00000172			 proc ProperAspect near
    267					 ; prepare proper active area
    268	00000172  83 E0	0F		   and eax,0Fh ; limit index
    269	00000175  0F B7	54 87 32	   movzx edx,[word(edi+eax*4+tbl.xMax0)]
    270	0000017A  89 57	04		   mov [edi+tbl.xMaxPos],edx
    271	0000017D  0F B7	54 87 34	   movzx edx,[word(edi+eax*4+tbl.yMax0)]
    272	00000182  89 57	08		   mov [edi+tbl.yMaxPos],edx
    273					 ; verify proper aspect	ratio
    274	00000185  80 3D	0000001Dr 01	   cmp [CircleMode],1 ;	circles
    275	0000018C  BE 00000063r		   mov esi,offset(PutScreenEvent)
    276	00000191  75 38			   jne EndProperAspect ; nope
    277					 ; fit screen x	into tablet
    278	00000193  8B 46	0E		   mov eax,[esi+scr.yMaxOut]
    279	00000196  F7 67	04		   mul [edi+tbl.xMaxPos]
    280	00000199  F7 77	08		   div [edi+tbl.yMaxPos]
    281	0000019C  3B 46	0A		   cmp eax,[esi+scr.xMaxOut]
    282	0000019F  73 03			   jnb EndxMaxTablet ; fit
    283	000001A1  8B 46	0A		   mov eax,[esi+scr.xMaxOut]
    284	000001A4			 label EndxMaxTablet near
    285	000001A4  89 47	0C		   mov [edi+tbl.xMaxOut],eax
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 6
bamboo.asm



    286	000001A7  2B 46	0A		   sub eax,[esi+scr.xMaxOut]
    287	000001AA  D1 E8			   shr eax,1 ; offset position
    288	000001AC  89 47	14		   mov [edi+tbl.xMinOut],eax
    289					 ; fit screen y	into tablet
    290	000001AF  8B 46	0A		   mov eax,[esi+scr.xMaxOut]
    291	000001B2  F7 67	08		   mul [edi+tbl.yMaxPos]
    292	000001B5  F7 77	04		   div [edi+tbl.xMaxPos]
    293	000001B8  3B 46	0E		   cmp eax,[esi+scr.yMaxOut]
    294	000001BB  73 03			   jnb EndyMaxTablet ; fit
    295	000001BD  8B 46	0E		   mov eax,[esi+scr.yMaxOut]
    296	000001C0			 label EndyMaxTablet near
    297	000001C0  89 47	10		   mov [edi+tbl.yMaxOut],eax
    298	000001C3  2B 46	0E		   sub eax,[esi+scr.yMaxOut]
    299	000001C6  D1 E8			   shr eax,1 ; offset position
    300	000001C8  89 47	18		   mov [edi+tbl.yMinOut],eax
    301	000001CB			 label EndProperAspect near
    302					 ; return to caller
    303	000001CB  C3			   ret ; return
    304	000001CC			 endp ProperAspect
    305
    306		  =000C			 nMax=12 ; entries
    307
    308	000001CC			 struc flt
    309					 ; rolling average
    310	00000000  01*(????????)		 FltN dd ? ; filter
    311	00000004  01*(????????)		 UseN dd ? ; entries
    312	00000008  01*(00000000)		 PosN dd 0 ; index
    313	0000000C  01*(00000000)		 SumX dd 0 ; rolling
    314	00000010  01*(00000000)		 SumY dd 0 ; rolling
    315	00000014  01*(00000000)		 TotX dd 0 ; output
    316	00000018  01*(00000000)		 TotY dd 0 ; output
    317	0000001C  01*(0C*(00000000))	 ValX dd nMax dup(0)
    318	0000004C  01*(0C*(00000000))	 ValY dd nMax dup(0)
    319	0000007C			 ends flt
    320
    321	000001CC			 codeseg
    322	000001CC			 proc RollingAverage near
    323					 ; check reset average
    324	000001CC  3C 00			   cmp al,0 ; reset
    325	000001CE  75 23			   jne EndResetAverage
    326					 ; reset rolling average
    327	000001D0  2B C0			   sub eax,eax ; zeroes
    328	000001D2  89 47	0C		   mov [edi+flt.SumX],eax
    329	000001D5  89 47	10		   mov [edi+flt.SumY],eax
    330	000001D8  0F B7	5E 0A		   movzx ebx,[word(esi+10)]
    331	000001DC  0F B7	56 0C		   movzx edx,[word(esi+12)]
    332	000001E0  8B 4F	04		   mov ecx,[edi+flt.UseN]
    333	000001E3			 label ResetAverage near
    334	000001E3  89 5C	8F 18		   mov [edi-4+ecx*4+flt.ValX],ebx
    335	000001E7  89 54	8F 48		   mov [edi-4+ecx*4+flt.ValY],edx
    336	000001EB  01 5F	0C		   add [edi+flt.SumX],ebx
    337	000001EE  01 57	10		   add [edi+flt.SumY],edx
    338	000001F1  E2 F0			   loop	ResetAverage
    339	000001F3			 label EndResetAverage near
    340					 ; update rolling position
    341	000001F3  8B 4F	08		   mov ecx,[edi+flt.PosN]
    342	000001F6  49			   dec ecx ; next position
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 7
bamboo.asm



    343	000001F7  79 03			   jns EndFilterIndex ;	ok
    344	000001F9  03 4F	04		   add ecx,[edi+flt.UseN]
    345	000001FC			 label EndFilterIndex near
    346	000001FC  89 4F	08		   mov [edi+flt.PosN],ecx
    347					 ; build current x position
    348	000001FF  0F B7	46 0A		   movzx eax,[word(esi+10)]
    349					 ; update rolling x amount
    350	00000203  8B 5C	8F 1C		   mov ebx,[edi+ecx*4+flt.ValX]
    351	00000207  89 44	8F 1C		   mov [edi+ecx*4+flt.ValX],eax
    352	0000020B  03 47	0C		   add eax,[edi+flt.SumX]
    353	0000020E  2B C3			   sub eax,ebx ; old sample
    354	00000210  89 47	0C		   mov [edi+flt.SumX],eax
    355					 ; apply stylus	x filter
    356	00000213  8B 5F	14		   mov ebx,[edi+flt.TotX]
    357	00000216  2B D8			   sub ebx,eax ; deviation
    358	00000218  79 02			   jns xRolPositive ; ok
    359	0000021A  F7 DB			   neg ebx ; make positive
    360	0000021C			 label xRolPositive near
    361	0000021C  3B 1F			   cmp ebx,[edi+flt.FltN]
    362	0000021E  73 03			   jnb EndRolSmoothX ; new
    363	00000220  8B 47	14		   mov eax,[edi+flt.TotX]
    364	00000223			 label EndRolSmoothX near
    365	00000223  89 47	14		   mov [edi+flt.TotX],eax
    366					 ; new rolling x average
    367	00000226  2B D2			   sub edx,edx ; zeroes
    368	00000228  F7 77	04		   div [edi+flt.UseN]
    369					 ; store new x position
    370	0000022B  66| 89 46 0A		   mov [word(esi+10)],ax
    371					 ; build current y position
    372	0000022F  0F B7	46 0C		   movzx eax,[word(esi+12)]
    373					 ; update rolling y amount
    374	00000233  8B 5C	8F 4C		   mov ebx,[edi+ecx*4+flt.ValY]
    375	00000237  89 44	8F 4C		   mov [edi+ecx*4+flt.ValY],eax
    376	0000023B  03 47	10		   add eax,[edi+flt.SumY]
    377	0000023E  2B C3			   sub eax,ebx ; old sample
    378	00000240  89 47	10		   mov [edi+flt.SumY],eax
    379					 ; apply stylus	y filter
    380	00000243  8B 5F	18		   mov ebx,[edi+flt.TotY]
    381	00000246  2B D8			   sub ebx,eax ; deviation
    382	00000248  79 02			   jns yRolPositive ; ok
    383	0000024A  F7 DB			   neg ebx ; make positive
    384	0000024C			 label yRolPositive near
    385	0000024C  3B 1F			   cmp ebx,[edi+flt.FltN]
    386	0000024E  73 03			   jnb EndRolSmoothY ; new
    387	00000250  8B 47	18		   mov eax,[edi+flt.TotY]
    388	00000253			 label EndRolSmoothY near
    389	00000253  89 47	18		   mov [edi+flt.TotY],eax
    390					 ; new rolling y average
    391	00000256  2B D2			   sub edx,edx ; zeroes
    392	00000258  F7 77	04		   div [edi+flt.UseN]
    393					 ; store new y position
    394	0000025B  66| 89 46 0C		   mov [word(esi+12)],ax
    395					 ; return to caller
    396	0000025F  C3			   ret ; return
    397	00000260			 endp RollingAverage
    398
    399	00000260			 dataseg
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 8
bamboo.asm



    400	0000001E  80 06	00 01 00 00 12+	 GetDevDescriptor db 80h,06h,00h,01h,00h,00h,12h,00h,12h dup(0EEh)
    401		  00 12*(EE)
    402
    403	00000038			 codeseg
    404	00000260			 proc ControlTransfer near
    405					 ; execute control transfer
    406	00000260  88 47	06		   mov [edi+6],al ; data size
    407	00000263  8D 50	08		   lea edx,[eax+8] ; total size
    408					   call	DosWrite c,[fhTablet],edi,edx,offset(BytesDone)
1   409	00000266  68 00000004r			 PUSH	 OFFSET(BYTESDONE)
1   410	0000026B  52				 PUSH	 EDX
1   411	0000026C  57				 PUSH	 EDI
1   412	0000026D  FF 35	0000000Cr		 PUSH	 [FHTABLET]
1   413	00000273  E8 00000000e			 CALL	 DOSWRITE
1   414	00000278  83 C4	10			 ADD	 ESP,00010h
    415	0000027B  85 C0			   test	eax,eax	; success
    416					 ; return to caller
    417	0000027D  C3			   ret ; return
    418	0000027E			 endp ControlTransfer
    419
    420	0000027E			 dataseg
    421	00000038  00 09	01 00 00 00 00+	 SetConfiguration db 00h,09h,01h,00h,00h,00h,00h,00h
    422		  00
    423	00000040  21 09	02 03 00 00 02+	 SetFeatureReport db 21h,09h,02h,03h,00h,00h,02h,00h,02h,02h
    424		  00 02	02
    425
    426	0000004A			 dataseg
    427					 ; idProduct<D0><D1><D2><D3><D4><D5><D6><D7><D8><D9><DA><DB><DC><DD><DE><DF>
    428	0000004A  10 30	30 31 20 21 30+	 TypeSize db 10h,30h,30h,31h,20h,21h,30h,30h,31h,00h,30h,31h,00h,20h,30h,31h
    429		  30 31	00 30 31 00 20+
    430		  30 31
    431
    432	0000005A			 codeseg
    433	0000027E			 proc SwitchTablet near
    434					 ; hang	in here	some minimum time
    435					   call	DosSleep c,50 ;	milliseconds
1   436	0000027E  6A 32				 PUSH	 50
1   437	00000280  E8 00000000e			 CALL	 DOSSLEEP
1   438	00000285  83 C4	04			 ADD	 ESP,00004h
    439					 ; get device descriptor request
    440	00000288  BF 0000001Er		   mov edi,offset(GetDevDescriptor)
    441	0000028D  B8 00000012		   mov eax,12h ; data length
    442	00000292  E8 FFFFFFC9		   call	ControlTransfer
    443	00000297  75 E5			   jnz SwitchTablet
    444					 ; set configuration request
    445	00000299  BF 00000038r		   mov edi,offset(SetConfiguration)
    446	0000029E  E8 FFFFFFBD		   call	ControlTransfer
    447	000002A3  75 D9			   jnz SwitchTablet
    448					 ; set feature report request
    449	000002A5  BF 00000040r		   mov edi,offset(SetFeatureReport)
    450	000002AA  B0 02			   mov al,02h ;	data length
    451	000002AC  E8 FFFFFFAF		   call	ControlTransfer
    452	000002B1  75 CB			   jnz SwitchTablet
    453					 ; hang	in here	some minimum time
    454					   call	DosSleep c,50 ;	milliseconds
1   455	000002B3  6A 32				 PUSH	 50
1   456	000002B5  E8 00000000e			 CALL	 DOSSLEEP
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 9
bamboo.asm



1   457	000002BA  83 C4	04			 ADD	 ESP,00004h
    458					 ; setup tablet	capabilities
    459	000002BD  A0 00000030r		   mov al,[GetDevDescriptor+18]
    460	000002C2  83 E0	0F		   and eax,0Fh ; limit index
    461	000002C5  8A 80	0000004Ar	   mov al,[TypeSize+eax]
    462					 ; return to caller
    463	000002CB  C3			   ret ; return
    464	000002CC			 endp SwitchTablet
    465
    466	000002CC			 codeseg
    467	000002CC			 proc TabletToScreen c near
    468					 arg @@xCurPos,@@yCurPos
    469					 ; save	tablet position
1   470	000002CC  C8 0000 00			 ENTERD	 00000h,0
1   471	000002D0  8B 47	1C		   mov eax,[edi+tbl.xNewPos]
    472	000002D3  89 47	24		   mov [edi+tbl.xOldPos],eax
    473	000002D6  8B 47	20		   mov eax,[edi+tbl.yNewPos]
    474	000002D9  89 47	28		   mov [edi+tbl.yOldPos],eax
    475					 ; convert current xpos
    476	000002DC  8B 45	08		   mov eax,[@@xCurPos]
    477	000002DF  F7 67	0C		   mul [edi+tbl.xMaxOut]
    478	000002E2  F7 77	04		   div [edi+tbl.xMaxPos]
    479	000002E5  2B 47	14		   sub eax,[edi+tbl.xMinOut]
    480	000002E8  79 02			   jns xPosNewPosition ; ok
    481	000002EA  2B C0			   sub eax,eax ; minimum
    482	000002EC			 label xPosNewPosition near
    483	000002EC  89 47	1C		   mov [edi+tbl.xNewPos],eax
    484					 ; convert current ypos
    485	000002EF  8B 45	0C		   mov eax,[@@yCurPos]
    486	000002F2  F7 67	10		   mul [edi+tbl.yMaxOut]
    487	000002F5  F7 77	08		   div [edi+tbl.yMaxPos]
    488	000002F8  2B 47	18		   sub eax,[edi+tbl.yMinOut]
    489	000002FB  79 02			   jns yPosNewPosition ; ok
    490	000002FD  2B C0			   sub eax,eax ; minimum
    491	000002FF			 label yPosNewPosition near
    492	000002FF  89 47	20		   mov [edi+tbl.yNewPos],eax
    493					 ; verify screen position
    494	00000302  80 7F	02 01		   cmp [edi+tbl.EvntBt2],1
    495	00000306  74 10			   je UsePosition ; use
    496	00000308  C6 47	02 01		   mov [edi+tbl.EvntBt2],1
    497					 ; save	tablet position
    498	0000030C  8B 47	1C		   mov eax,[edi+tbl.xNewPos]
    499	0000030F  89 47	24		   mov [edi+tbl.xOldPos],eax
    500	00000312  8B 47	20		   mov eax,[edi+tbl.yNewPos]
    501	00000315  89 47	28		   mov [edi+tbl.yOldPos],eax
    502	00000318			 label UsePosition near
    503					 ; return to caller
1   504	00000318  C9				 LEAVED
1   505	00000319  C3				 RET	 00000h
    506	0000031A			 endp TabletToScreen
    507
    508	0000031A			 dataseg
    509	0000005A  00000001		 FingerMode dd 1 ; relative
    510	0000005E  00000000		 StylusMode dd 0 ; absolute
    511
    512	00000062			 dataseg
    513	00000062  00			 ButtonMode db 0 ; right
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 10
bamboo.asm



    514
    515	00000063			 dataseg
    516	00000063  0001 0190 0280 0320 +	 PutScreenEvent	scr {}
    517		  0500 00000500	      +
    518		  00000320 00000280   +
    519		  00000190 0101	1806  +
    520		  0618 1E1E 6060 7866 +
    521		  6678 7E7E
    522
    523	0000008D			 dataseg
    524	0000008D  00			 TabletRotate db 0 ; no
    525
    526	0000008E			 codeseg
    527	0000031A			 proc WriteScreen c near
    528					 arg @@MouseMode
    529					 local @@BytesDone
    530					 ; prepare screen work pointer
1   531	0000031A  C8 0004 00			 ENTERD	 00004h,0
1   532	0000031E  BA 00000063r		   mov edx,offset(PutScreenEvent)
    533					 ; provide current event
    534	00000323  8A 07			   mov al,[edi+tbl.EvntBt0]
    535	00000325  88 02			   mov [edx],al	; event
    536					 ; update screen position
    537	00000327  80 7F	02 01		   cmp [edi+tbl.EvntBt2],1
    538	0000032B  75 5C			   jne WriteEvent ; skip
    539					 ; obtain tablet position
    540	0000032D  8B 5F	1C		   mov ebx,[edi+tbl.xNewPos]
    541	00000330  8B 4F	20		   mov ecx,[edi+tbl.yNewPos]
    542					 ; check relative mode
    543	00000333  8B 45	08		   mov eax,[@@MouseMode]
    544	00000336  3C 01			   cmp al,1 ; relative
    545	00000338  75 14			   jne EndMouseMode ; no
    546					 ; update relative position
    547	0000033A  2B 5F	24		   sub ebx,[edi+tbl.xOldPos]
    548	0000033D  2B 4F	28		   sub ecx,[edi+tbl.yOldPos]
    549					 ; update absolute xpos
    550	00000340  03 5A	12		   add ebx,[edx+scr.xOutPos]
    551					 ; verify minimum xpos
    552	00000343  79 02			   jns xPosPositive
    553	00000345  2B DB			   sub ebx,ebx ; minimum
    554	00000347			 label xPosPositive near
    555					 ; update absolute ypos
    556	00000347  03 4A	16		   add ecx,[edx+scr.yOutPos]
    557					 ; verify minimum ypos
    558	0000034A  79 02			   jns yPosPositive
    559	0000034C  2B C9			   sub ecx,ecx ; minimum
    560	0000034E			 label yPosPositive near
    561	0000034E			 label EndMouseMode near
    562					 ; verify maximum xpos
    563	0000034E  3B 5A	0A		   cmp ebx,[edx+scr.xMaxOut]
    564	00000351  76 03			   jna xPosAccepted
    565	00000353  8B 5A	0A		   mov ebx,[edx+scr.xMaxOut]
    566	00000356			 label xPosAccepted near
    567					 ; verify maximum ypos
    568	00000356  3B 4A	0E		   cmp ecx,[edx+scr.yMaxOut]
    569	00000359  76 03			   jna yPosAccepted
    570	0000035B  8B 4A	0E		   mov ecx,[edx+scr.yMaxOut]
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 11
bamboo.asm



    571	0000035E			 label yPosAccepted near
    572					 ; supply screen position
    573	0000035E  89 5A	12		   mov [edx+scr.xOutPos],ebx
    574	00000361  89 4A	16		   mov [edx+scr.yOutPos],ecx
    575					 ; rotate tablet position
    576	00000364  80 3D	0000008Dr 01	   cmp [TabletRotate],1
    577	0000036B  75 14			   jne NotRotate ; no
    578					 ; reverse tablet xpos
    579	0000036D  8B 42	0A		   mov eax,[edx+scr.xMaxOut]
    580	00000370  2B C3			   sub eax,ebx ; downwards
    581	00000372  66| 89 42 04		   mov [edx+scr.xCurPos],ax
    582					 ; reverse tablet ypos
    583	00000376  8B 42	0E		   mov eax,[edx+scr.yMaxOut]
    584	00000379  2B C1			   sub eax,ecx ; downwards
    585	0000037B  66| 89 42 02		   mov [edx+scr.yCurPos],ax
    586	0000037F  EB 08			   jmp EndRotate ; done
    587	00000381			 label NotRotate near
    588	00000381  66| 89 5A 04		   mov [edx+scr.xCurPos],bx
    589	00000385  66| 89 4A 02		   mov [edx+scr.yCurPos],cx
    590	00000389			 label EndRotate near
    591	00000389			 label WriteEvent near
    592					 ; write screen	event
    593	00000389  8D 45	FC		   lea eax,[@@BytesDone]
    594					   call	DosWrite c,[fhScreen],edx,10,eax
1   595	0000038C  50				 PUSH	 EAX
1   596	0000038D  6A 0A				 PUSH	 10
1   597	0000038F  52				 PUSH	 EDX
1   598	00000390  FF 35	00000008r		 PUSH	 [FHSCREEN]
1   599	00000396  E8 00000000e			 CALL	 DOSWRITE
1   600	0000039B  83 C4	10			 ADD	 ESP,00010h
    601					 ; return to caller
1   602	0000039E  C9				 LEAVED
1   603	0000039F  C3				 RET	 00000h
    604	000003A0			 endp WriteScreen
    605
    606	000003A0			 dataseg
    607	0000008E  EC 00	FF FF 82 03 14+	 GetFingerInput	db 0ECh,00h,0FFh,0FFh,82h,03h,14h,00h,14h dup(0EEh)
    608		  00 14*(EE)
    609
    610	000000AA			 dataseg
    611	000000AA  00 00	00 00 08*(??) +	 PutFingerEvent	tbl {xMax0=480,yMax0=320,xMax1=720,yMax1=480}
    612		  00000500 00000320   +
    613		  00000000 00000000   +
    614		  00000000 00000000   +
    615		  00000000 00000000   +
    616		  1806 0618 6060 01E0 +
    617		  0140 02D0 01E0
    618
    619	000000E4			 udataseg
    620	00000014  ????????		 FingerDone dd ?
    621
    622	00000018			 dataseg
    623	000000E4  0000000C 0000000C   +	 Finger	flt {FltN=1*nMax,UseN=nMax}
    624		  00000000 00000000   +
    625		  00000000 00000000   +
    626		  00000000 0C*	      +
    627		  (00000000) 0C*      +
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 12
bamboo.asm



    628		  (00000000)
    629
    630	00000160			 codeseg
    631	000003A0			 proc FingerProcess near
    632					 ; setup finger	configuration
    633	000003A0  E8 FFFFFED9		   call	SwitchTablet ; prepare
    634					 ; verify finger capabilities
    635	000003A5  A8 10			   test	al,10h ; finger	support
    636	000003A7  0F 84	000000D2	   jz UseStylusEvent ; switch
    637	000003AD			 label UseFingerEvent near
    638					 ; apply proper	aspect ratio
    639	000003AD  BF 000000AAr		   mov edi,offset(PutFingerEvent)
    640	000003B2  E8 FFFFFDBB		   call	ProperAspect ; finger
    641	000003B7  BE 0000008Er		   mov esi,offset(GetFingerInput)
    642					 ; reset finger	position
    643	000003BC  C6 47	02 00		   mov [edi+tbl.EvntBt2],0
    644	000003C0			 label GetFingerEvent near
    645	000003C0  C6 46	06 14		   mov [byte(esi+6)],14h ; reset
    646					   call	DosWrite c,[fhTablet],esi,28,offset(FingerDone)
1   647	000003C4  68 00000014r			 PUSH	 OFFSET(FINGERDONE)
1   648	000003C9  6A 1C				 PUSH	 28
1   649	000003CB  56				 PUSH	 ESI
1   650	000003CC  FF 35	0000000Cr		 PUSH	 [FHTABLET]
1   651	000003D2  E8 00000000e			 CALL	 DOSWRITE
1   652	000003D7  83 C4	10			 ADD	 ESP,00010h
    653	000003DA  85 C0			   test	eax,eax	; success
    654	000003DC  75 C2			   jnz FingerProcess
    655					 ; verify finger event
    656	000003DE  80 7E	08 02		   cmp [byte(esi+8)],02h
    657	000003E2  75 DC			   jne GetFingerEvent
    658					 ; check tablet	rotated
    659	000003E4  8A 46	09		   mov al,[esi+9] ; event
    660	000003E7  80 3D	0000008Dr 01	   cmp [TabletRotate],1
    661	000003EE  75 0C			   jne EndRotation ; ok
    662					 ; rotate express keys
    663	000003F0  2B C9			   sub ecx,ecx ; loop
    664	000003F2  B1 04			   mov cl,04h ;	counter
    665	000003F4			 label KeyRotate near
    666	000003F4  D0 D8			   rcr al,1 ; one bit
    667	000003F6  D0 D4			   rcl ah,1 ; one bit
    668	000003F8  E2 FA			   loop	KeyRotate
    669	000003FA  8A C4			   mov al,ah ; event
    670	000003FC			 label EndRotation near
    671					 ; process finger event
    672	000003FC  B4 01			   mov ah,001h ; MoveOnly
    673	000003FE  80 7E	19 11		   cmp [byte(esi+25)],011h
    674	00000402  74 06			   je EndPosition ; single
    675	00000404			 label NotPosition near
    676					 ; reset finger	position
    677	00000404  C6 47	02 00		   mov [edi+tbl.EvntBt2],0
    678	00000408  B4 00			   mov ah,000h ; NoButMov
    679	0000040A			 label EndPosition near
    680	0000040A  3C 00			   cmp al,000h ; NoButMov
    681	0000040C  74 0F			   je FingerToMouseEvent
    682					 ; obtain mouse	actions
    683	0000040E  E8 FFFFFD38		   call	MouseActions
    684					 ; process stylus events
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 13
bamboo.asm



    685	00000413  3C 08			   cmp al,008h ; Bt0008Down
    686	00000415  72 06			   jb FingerToMouseEvent
    687					 ; action switch to stylus
    688	00000417  3C 0A			   cmp al,00Ah ; Bt0208Down
    689	00000419  74 57			   je StylusProcess
    690					 ; ignore unused buttons
    691	0000041B  EB A3			   jmp GetFingerEvent
    692	0000041D			 label FingerToMouseEvent near
    693					 ; store emulated mouse	event
    694	0000041D  88 27			   mov [edi+tbl.EvntBt0],ah
    695					 ; current finger position
    696	0000041F  0F B6	46 0C		   movzx eax,[byte(esi+12)]
    697	00000423  32 66	0B		   xor ah,[byte(esi+11)]
    698	00000426  79 37			   jns WriteFingerEvent
    699	00000428  80 E4	01		   and ah,01h ;	validate xpos
    700	0000042B  0F B6	56 0E		   movzx edx,[byte(esi+14)]
    701	0000042F  8A 76	0D		   mov dh,[byte(esi+13)]
    702	00000432  80 E6	01		   and dh,01h ;	validate ypos
    703					 ; fix current finger position
    704	00000435  89 46	0A		   mov [esi+10],eax ; xpos
    705	00000438  89 56	0C		   mov [esi+12],edx ; ypos
    706					 ; apply rolling average
    707	0000043B  8A 47	02		   mov al,[edi+tbl.EvntBt2]
    708	0000043E  BF 000000E4r		   mov edi,offset(Finger)
    709	00000443  E8 FFFFFD84		   call	RollingAverage
    710					 ; finger to screen position
    711	00000448  BF 000000AAr		   mov edi,offset(PutFingerEvent)
    712	0000044D  0F B7	46 0A		   movzx eax,[word(esi+10)] ; xpos
    713	00000451  0F B7	56 0C		   movzx edx,[word(esi+12)] ; ypos
    714					   call	TabletToScreen c,eax,edx
1   715	00000455  52				 PUSH	 EDX
1   716	00000456  50				 PUSH	 EAX
1   717	00000457  E8 FFFFFE70			 CALL	 TABLETTOSCREEN
1   718	0000045C  83 C4	08			 ADD	 ESP,00008h
    719	0000045F			 label WriteFingerEvent	near
    720					 ; write emulated mouse	event
    721					   call	WriteScreen c,[FingerMode]
1   722	0000045F  FF 35	0000005Ar		 PUSH	 [FINGERMODE]
1   723	00000465  E8 FFFFFEB0			 CALL	 WRITESCREEN
1   724	0000046A  83 C4	04			 ADD	 ESP,00004h
    725	0000046D  E9 FFFFFF4E		   jmp GetFingerEvent
    726	00000472			 endp FingerProcess
    727
    728	00000472			 dataseg
    729	00000160  EC 00	FF FF 81 03 0A+	 GetStylusInput	db 0ECh,00h,0FFh,0FFh,81h,03h,0Ah,00h,0Ah dup(0EEh)
    730		  00 0A*(EE)
    731
    732	00000172			 dataseg
    733	00000172  00 00	00 00 08*(??) +	 PutStylusEvent	tbl {xMax0=14720,yMax0=9200,xMax1=21650,yMax1=13700}
    734		  00000500 00000320   +
    735		  00000000 00000000   +
    736		  00000000 00000000   +
    737		  00000000 00000000   +
    738		  1806 0618 6060 3980 +
    739		  23F0 5492 3584
    740
    741	000001AC			 udataseg
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 14
bamboo.asm



    742	00000018  ????????		 StylusDone dd ?
    743
    744	0000001C			 dataseg
    745	000001AC  00000060 0000000C   +	 Stylus	flt {FltN=8*nMax,UseN=nMax}
    746		  00000000 00000000   +
    747		  00000000 00000000   +
    748		  00000000 0C*	      +
    749		  (00000000) 0C*      +
    750		  (00000000)
    751
    752	00000228			 codeseg
    753	00000472			 proc StylusProcess near
    754					 ; setup stylus	configuration
    755	00000472  E8 FFFFFE07		   call	SwitchTablet ; prepare
    756					 ; verify stylus capabilities
    757	00000477  A8 20			   test	al,20h ; stylus	support
    758	00000479  0F 84	FFFFFF2E	   jz UseFingerEvent ; switch
    759	0000047F			 label UseStylusEvent near
    760					 ; apply proper	aspect ratio
    761	0000047F  BF 00000172r		   mov edi,offset(PutStylusEvent)
    762	00000484  E8 FFFFFCE9		   call	ProperAspect ; stylus
    763	00000489  BE 00000160r		   mov esi,offset(GetStylusInput)
    764					 ; reset stylus	position
    765	0000048E  C6 47	02 00		   mov [edi+tbl.EvntBt2],0
    766	00000492			 label GetStylusEvent near
    767	00000492  C6 46	06 0A		   mov [byte(esi+6)],0Ah ; reset
    768					   call	DosWrite c,[fhTablet],esi,18,offset(StylusDone)
1   769	00000496  68 00000018r			 PUSH	 OFFSET(STYLUSDONE)
1   770	0000049B  6A 12				 PUSH	 18
1   771	0000049D  56				 PUSH	 ESI
1   772	0000049E  FF 35	0000000Cr		 PUSH	 [FHTABLET]
1   773	000004A4  E8 00000000e			 CALL	 DOSWRITE
1   774	000004A9  83 C4	10			 ADD	 ESP,00010h
    775	000004AC  85 C0			   test	eax,eax	; success
    776	000004AE  75 C2			   jnz StylusProcess
    777					 ; verify stylus event
    778	000004B0  80 7E	08 02		   cmp [byte(esi+8)],02h
    779	000004B4  75 DC			   jne GetStylusEvent
    780					 ; process stylus event
    781	000004B6  8A 46	09		   mov al,[esi+9] ; event
    782					 ; accept border events
    783	000004B9  24 EF			   and al,0EFh ; +border
    784					 ; reset stylus	events
    785	000004BB  3C E0			   cmp al,0E0h ; Et0000Down
    786	000004BD  72 13			   jb ResetStylusEvent
    787					 ; obtain mouse	actions
    788	000004BF  E8 FFFFFC87		   call	MouseActions
    789					 ; process stylus events
    790	000004C4  3C E8			   cmp al,0E8h ; Et0008Down
    791	000004C6  72 18			   jb StylusToMouseEvent
    792					 ; action switch to finger
    793	000004C8  3C E9			   cmp al,0E9h ; Et1008Down
    794					 ; cmp al,0EBh ; Et1208Down
    795					 ; cmp al,0EDh ; Et1048Down
    796	000004CA  0F 84	FFFFFED0	   je FingerProcess
    797					 ; ignore unused buttons
    798	000004D0  EB C0			   jmp GetStylusEvent
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 15
bamboo.asm



    799	000004D2			 label ResetStylusEvent	near
    800					 ; reset stylus	position
    801	000004D2  C6 47	02 00		   mov [edi+tbl.EvntBt2],0
    802					 ; ensure buttons released
    803	000004D6  B4 00			   mov ah,000h ; NoButMov
    804	000004D8  38 27			   cmp [edi+tbl.EvntBt0],ah
    805	000004DA  74 B6			   je GetStylusEvent ; ok
    806	000004DC  88 27			   mov [edi+tbl.EvntBt0],ah
    807	000004DE  EB 26			   jmp WriteStylusEvent
    808	000004E0			 label StylusToMouseEvent near
    809					 ; store emulated mouse	event
    810	000004E0  88 27			   mov [edi+tbl.EvntBt0],ah
    811					 ; apply rolling average
    812	000004E2  8A 47	02		   mov al,[edi+tbl.EvntBt2]
    813	000004E5  BF 000001ACr		   mov edi,offset(Stylus)
    814	000004EA  E8 FFFFFCDD		   call	RollingAverage
    815					 ; stylus to screen position
    816	000004EF  BF 00000172r		   mov edi,offset(PutStylusEvent)
    817	000004F4  0F B7	46 0A		   movzx eax,[word(esi+10)] ; xpos
    818	000004F8  0F B7	56 0C		   movzx edx,[word(esi+12)] ; ypos
    819					   call	TabletToScreen c,eax,edx
1   820	000004FC  52				 PUSH	 EDX
1   821	000004FD  50				 PUSH	 EAX
1   822	000004FE  E8 FFFFFDC9			 CALL	 TABLETTOSCREEN
1   823	00000503  83 C4	08			 ADD	 ESP,00008h
    824	00000506			 label WriteStylusEvent	near
    825					 ; write emulated mouse	event
    826					   call	WriteScreen c,[StylusMode]
1   827	00000506  FF 35	0000005Er		 PUSH	 [STYLUSMODE]
1   828	0000050C  E8 FFFFFE09			 CALL	 WRITESCREEN
1   829	00000511  83 C4	04			 ADD	 ESP,00004h
    830	00000514  E9 FFFFFF79		   jmp GetStylusEvent
    831	00000519			 endp StylusProcess
    832
    833	00000519			 codeseg
    834	00000519			 proc dec2bin near
    835					 ; decimal to binary
    836	00000519  2B C0			   sub eax,eax ; input
    837	0000051B  2B D2			   sub edx,edx ; output
    838	0000051D			 label ConvertInput near
    839	0000051D  47			   inc edi ; next position
    840	0000051E  8A 07			   mov al,[edi]	; digit
    841					 ; convert decimal digit
    842	00000520  3C 30			   cmp al,'0' ;	minimum
    843	00000522  72 0E			   jb Enddec2bin ; done
    844	00000524  3C 39			   cmp al,'9' ;	maximum
    845	00000526  77 0A			   ja Enddec2bin ; done
    846	00000528  2C 30			   sub al,'0' ;	digit
    847	0000052A  8D 14	92		   lea edx,[edx*4+edx]
    848	0000052D  8D 14	50		   lea edx,[edx*2+eax]
    849	00000530  EB EB			   jmp ConvertInput
    850	00000532			 label Enddec2bin Near
    851					 ; return to caller
    852	00000532  C3			   ret ; return
    853	00000533			 endp dec2bin
    854
    855	00000533			 codeseg
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 16
bamboo.asm



    856	00000533			 proc MouseButtons c near
    857					 uses ecx ; button index
    858					 ; initialize button index
1   859	00000533  51				 PUSH	 ECX
1   860	00000534  2B C9			   sub ecx,ecx ; 1st button
    861	00000536			 label UpdateButton near
    862					 ; verify action index
    863	00000536  47			   inc edi ; next position
    864	00000537  0F B6	07		   movzx eax,[byte(edi)]
    865	0000053A  3C 30			   cmp al,'0' ;	minimum
    866	0000053C  72 16			   jb EndMouseButtons
    867	0000053E  3C 37			   cmp al,'7' ;	maximum
    868	00000540  77 12			   ja EndMouseButtons
    869					 ; update logical button
    870	00000542  24 07			   and al,07h ;	action index
    871	00000544  66| 8B 44 46 1A	   mov ax,[esi+eax*2+scr.Action0]
    872	00000549  66| 89 44 4A 2C	   mov [edx+ecx*2+tbl.Button1],ax
    873	0000054E  41			   inc ecx ; next button index
    874	0000054F  80 F9	03		   cmp cl,03h ;	last button
    875	00000552  72 E2			   jb UpdateButton ; next
    876	00000554			 label EndMouseButtons near
    877					 ; return to caller
1   878	00000554  59				 POP	 ECX
1   879	00000555  C3				 RET	 00000h
    880	00000556			 endp MouseButtons
    881
    882	00000556			 codeseg
    883	00000556			 proc ProcessArguments near
    884					 ; scan	for forward slash
    885	00000556  8A 07			   mov al,[edi]	; character
    886	00000558  47			   inc edi ; next position
    887	00000559  3C 00			   cmp al,00h ;	terminator
    888	0000055B  0F 84	000000CC	   je EndScanString ; done
    889	00000561  3C 2F			   cmp al,'/' ;	parameter
    890	00000563  75 F1			   jne ProcessArguments
    891					 ; allow upper/lower case
    892	00000565  8A 07			   mov al,[edi]	; character
    893	00000567  0C 20			   or al,20h; ignore case
    894					 ; finger absolute mode
    895	00000569  3C 61			   cmp al,'a' ;	absolute
    896	0000056B  75 09			   jne NotAbsoluteMode
    897	0000056D  C6 05	0000005Ar 00	   mov [byte(FingerMode)],0
    898	00000574  EB E0			   jmp ProcessArguments
    899	00000576			 label NotAbsoluteMode near
    900					 ; stylus button setting
    901	00000576  3C 62			   cmp al,'b' ;	buttons
    902	00000578  75 09			   jne NotStylusButton
    903	0000057A  8B D1			   mov edx,ecx ; stylus
    904	0000057C  E8 FFFFFFB2		   call	MouseButtons
    905	00000581  EB D3			   jmp ProcessArguments
    906	00000583			 label NotStylusButton near
    907					 ; stylus correct circles
    908	00000583  3C 63			   cmp al,'c' ;	circles
    909	00000585  75 09			   jne NotCircleMode
    910	00000587  C6 05	0000001Dr 01	   mov [CircleMode],1
    911	0000058E  EB C6			   jmp ProcessArguments
    912	00000590			 label NotCircleMode near
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 17
bamboo.asm



    913					 ; finger button setting
    914	00000590  3C 6B			   cmp al,'k' ;	keys
    915	00000592  75 09			   jne NotFingerButton
    916	00000594  8B D3			   mov edx,ebx ; finger
    917	00000596  E8 FFFFFF98		   call	MouseButtons
    918	0000059B  EB B9			   jmp ProcessArguments
    919	0000059D			 label NotFingerButton near
    920					 ; left	handed mouse set
    921	0000059D  3C 6C			   cmp al,'l' ;	lefty
    922	0000059F  75 09			   jne NotLeftHanded
    923	000005A1  C6 05	00000062r 01	   mov [ButtonMode],1
    924	000005A8  EB AC			   jmp ProcessArguments
    925	000005AA			 label NotLeftHanded near
    926					 ; stylus relative mode
    927	000005AA  3C 6D			   cmp al,'m' ;	mouse
    928	000005AC  75 09			   jne NotRelativeMode
    929	000005AE  C6 05	0000005Er 01	   mov [byte(StylusMode)],1
    930	000005B5			 label ProceszArguments	near
    931					 ; intermediate	jump back
    932	000005B5  EB 9F			   jmp ProcessArguments
    933	000005B7			 label NotRelativeMode near
    934					 ; tablet rotate setting
    935	000005B7  3C 72			   cmp al,'r' ;	rotate
    936	000005B9  75 09			   jne NotTabletRotate
    937	000005BB  C6 05	0000008Dr 01	   mov [TabletRotate],1
    938	000005C2  EB F1			   jmp ProceszArguments
    939	000005C4			 label NotTabletRotate near
    940					 ; initial touch setting
    941	000005C4  3C 74			   cmp al,'t' ;	touch
    942	000005C6  75 09			   jne NotSelectTouch
    943	000005C8  C6 05	0000001Cr 01	   mov [SelectTouch],1
    944	000005CF  EB E4			   jmp ProceszArguments
    945	000005D1			 label NotSelectTouch near
    946					 ; screen height setting
    947	000005D1  3C 68			   cmp al,'h' ;	height
    948	000005D3  75 2A			   jne NotScreenHeight
    949	000005D5  E8 FFFFFF3F		   call	dec2bin	; convert
    950					 ; verify screen height
    951	000005DA  81 FA	00008000	   cmp edx,1024*32 ; max
    952	000005E0  77 D3			   ja ProceszArguments
    953	000005E2  83 FA	20		   cmp edx,1024/32 ; min
    954	000005E5  72 CE			   jb ProceszArguments
    955					 ; update tablet heights
    956	000005E7  89 53	10		   mov [ebx+tbl.yMaxOut],edx
    957	000005EA  89 51	10		   mov [ecx+tbl.yMaxOut],edx
    958					 ; update screen heights
    959	000005ED  66| 89 56 06		   mov [esi+scr.yMaxPos],dx
    960	000005F1  89 56	0E		   mov [esi+scr.yMaxOut],edx
    961	000005F4  D1 EA			   shr edx,1 ; center position
    962	000005F6  89 56	16		   mov [esi+scr.yOutPos],edx
    963	000005F9  66| 89 56 02		   mov [esi+scr.yCurPos],dx
    964	000005FD  EB B6			   jmp ProceszArguments
    965	000005FF			 label NotScreenHeight near
    966					 ; screen width	setting
    967	000005FF  3C 77			   cmp al,'w' ;	width
    968	00000601  75 B2			   jne ProceszArguments
    969	00000603  E8 FFFFFF11		   call	dec2bin	; convert
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 18
bamboo.asm



    970					 ; verify screen width
    971	00000608  81 FA	00008000	   cmp edx,1024*32 ; max
    972	0000060E  77 A5			   ja ProceszArguments
    973	00000610  83 FA	20		   cmp edx,1024/32 ; min
    974	00000613  72 A0			   jb ProceszArguments
    975					 ; update tablet widths
    976	00000615  89 53	0C		   mov [ebx+tbl.xMaxOut],edx
    977	00000618  89 51	0C		   mov [ecx+tbl.xMaxOut],edx
    978					 ; update screen widths
    979	0000061B  66| 89 56 08		   mov [esi+scr.xMaxPos],dx
    980	0000061F  89 56	0A		   mov [esi+scr.xMaxOut],edx
    981	00000622  D1 EA			   shr edx,1 ; center position
    982	00000624  89 56	12		   mov [esi+scr.xOutPos],edx
    983	00000627  66| 89 56 04		   mov [esi+scr.xCurPos],dx
    984	0000062B  EB 88			   jmp ProceszArguments
    985	0000062D			 label EndScanString near
    986					 ; return to caller
    987	0000062D  C3			   ret ; return
    988	0000062E			 endp ProcessArguments
    989
    990					 end MainRoutine
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 19
Symbol Table




Symbol Name			  Type	 Value

??DATE				  Text	 "28-01-12"
??FILENAME			  Text	 "bamboo  "
??TIME				  Text	 "09:09:12"
??VERSION			  Number 0401
@32BIT				  Text	 1
@@ARG				  Number [FLAT:EBP+0014]
@@BYTESDONE			  Number [FLAT:EBP-0004]
@@ENV				  Number [FLAT:EBP+0010]
@@MOD				  Number [FLAT:EBP+0008]
@@MOUSEMODE			  Number [FLAT:EBP+0008]
@@NUL				  Number [FLAT:EBP+000C]
@@PARAMETER			  Number [FLAT:EBP+0008]
@@REASONCODE			  Number [FLAT:EBP+0008]
@@XCURPOS			  Number [FLAT:EBP+0008]
@@YCURPOS			  Number [FLAT:EBP+000C]
@CODE				  Text	 FLAT
@CODESIZE			  Text	 0
@CPU				  Text	 1F9FH
@CURSEG				  Text	 _TEXT
@DATA				  Text	 FLAT
@DATASIZE			  Text	 0
@FILENAME			  Text	 BAMBOO
@INTERFACE			  Text	 00H
@MODEL				  Text	 1
@STACK				  Text	 FLAT
@WORDSIZE			  Text	 4
ACTIONTAKEN			  Dword	 FLAT:0000
BADTABLETTHREAD			  Near	 FLAT:013F
BUTTONMODE			  Byte	 FLAT:0062
BYTESDONE			  Dword	 FLAT:0004
CIRCLEMODE			  Byte	 FLAT:001D
CONTROLTRANSFER			  Near	 FLAT:0260
CONVERTINPUT			  Near	 FLAT:051D
DEC2BIN				  Near	 FLAT:0519
DOSCLOSE			  Near	 ----:---- Extern
DOSCREATETHREAD			  Near	 ----:---- Extern
DOSEXIT				  Near	 ----:---- Extern
DOSEXITLIST			  Near	 ----:---- Extern
DOSOPEN				  Near	 ----:---- Extern
DOSSETPRIORITY			  Near	 ----:---- Extern
DOSSLEEP			  Near	 ----:---- Extern
DOSSUSPENDTHREAD		  Near	 ----:---- Extern
DOSWRITE			  Near	 ----:---- Extern
ENDBUTTON1			  Near	 FLAT:0163
ENDBUTTON2			  Near	 FLAT:016A
ENDBUTTON3			  Near	 FLAT:0171
ENDBUTTONS			  Near	 FLAT:0171
ENDDEC2BIN			  Near	 FLAT:0532
ENDFILTERINDEX			  Near	 FLAT:01FC
ENDMOUSEBUTTONS			  Near	 FLAT:0554
ENDMOUSEMODE			  Near	 FLAT:034E
ENDPOSITION			  Near	 FLAT:040A
ENDPROCESS			  Near	 FLAT:00C1
ENDPROPERASPECT			  Near	 FLAT:01CB
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 20
Symbol Table



ENDRESETAVERAGE			  Near	 FLAT:01F3
ENDROLSMOOTHX			  Near	 FLAT:0223
ENDROLSMOOTHY			  Near	 FLAT:0253
ENDROTATE			  Near	 FLAT:0389
ENDROTATION			  Near	 FLAT:03FC
ENDSCANSTRING			  Near	 FLAT:062D
ENDXMAXTABLET			  Near	 FLAT:01A4
ENDYMAXTABLET			  Near	 FLAT:01C0
FHSCREEN			  Dword	 FLAT:0008
FHTABLET			  Dword	 FLAT:000C
FINGER				  Struct FLAT:00E4 FLT
FINGERDONE			  Dword	 FLAT:0014
FINGERMODE			  Dword	 FLAT:005A
FINGERPROCESS			  Near	 FLAT:03A0
FINGERTOMOUSEEVENT		  Near	 FLAT:041D
GETDEVDESCRIPTOR		  Byte	 FLAT:001E
GETFINGEREVENT			  Near	 FLAT:03C0
GETFINGERINPUT			  Byte	 FLAT:008E
GETSTYLUSEVENT			  Near	 FLAT:0492
GETSTYLUSINPUT			  Byte	 FLAT:0160
KEYROTATE			  Near	 FLAT:03F4
MAINROUTINE			  Near	 FLAT:0000
MOUSEACTIONS			  Near	 FLAT:014B
MOUSEBUTTONS			  Near	 FLAT:0533
NMAX				  Number 000C
NOTABSOLUTEMODE			  Near	 FLAT:0576
NOTCIRCLEMODE			  Near	 FLAT:0590
NOTFINGERBUTTON			  Near	 FLAT:059D
NOTLEFTHANDED			  Near	 FLAT:05AA
NOTOPENSCREENDRIVER		  Near	 FLAT:00C5
NOTOPENTABLETDRIVER		  Near	 FLAT:00D3
NOTPOSITION			  Near	 FLAT:0404
NOTRELATIVEMODE			  Near	 FLAT:05B7
NOTROTATE			  Near	 FLAT:0381
NOTSCREENHEIGHT			  Near	 FLAT:05FF
NOTSELECTTOUCH			  Near	 FLAT:05D1
NOTSTYLUSBUTTON			  Near	 FLAT:0583
NOTTABLETROTATE			  Near	 FLAT:05C4
PROCESSARGUMENTS		  Near	 FLAT:0556
PROCESSCOMPLETE			  Near	 FLAT:00DF
PROCESZARGUMENTS		  Near	 FLAT:05B5
PROPERASPECT			  Near	 FLAT:0172
PUTFINGEREVENT			  Struct FLAT:00AA TBL
PUTSCREENEVENT			  Struct FLAT:0063 SCR
PUTSTYLUSEVENT			  Struct FLAT:0172 TBL
RESETAVERAGE			  Near	 FLAT:01E3
RESETSTYLUSEVENT		  Near	 FLAT:04D2
ROLLINGAVERAGE			  Near	 FLAT:01CC
SELECTTOUCH			  Byte	 FLAT:001C
SETCONFIGURATION		  Byte	 FLAT:0038
SETFEATUREREPORT		  Byte	 FLAT:0040
STYLUS				  Struct FLAT:01AC FLT
STYLUSDONE			  Dword	 FLAT:0018
STYLUSMODE			  Dword	 FLAT:005E
STYLUSPROCESS			  Near	 FLAT:0472
STYLUSTOMOUSEEVENT		  Near	 FLAT:04E0
SWITCHTABLET			  Near	 FLAT:027E
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 21
Symbol Table



SZSCREEN			  Byte	 FLAT:0000
SZTABLET			  Byte	 FLAT:000E
TABLETROTATE			  Byte	 FLAT:008D
TABLETTHREAD			  Near	 FLAT:0119
TABLETTOSCREEN			  Near	 FLAT:02CC
TIDTABLET			  Dword	 FLAT:0010
TYPESIZE			  Byte	 FLAT:004A
UPDATEBUTTON			  Near	 FLAT:0536
USEFINGEREVENT			  Near	 FLAT:03AD
USEPOSITION			  Near	 FLAT:0318
USESTYLUSEVENT			  Near	 FLAT:047F
WRITEEVENT			  Near	 FLAT:0389
WRITEFINGEREVENT		  Near	 FLAT:045F
WRITESCREEN			  Near	 FLAT:031A
WRITESTYLUSEVENT		  Near	 FLAT:0506
XMAXSCREEN			  Number 0500
XPOSACCEPTED			  Near	 FLAT:0356
XPOSNEWPOSITION			  Near	 FLAT:02EC
XPOSPOSITIVE			  Near	 FLAT:0347
XROLPOSITIVE			  Near	 FLAT:021C
YMAXSCREEN			  Number 0320
YPOSACCEPTED			  Near	 FLAT:035E
YPOSNEWPOSITION			  Near	 FLAT:02FF
YPOSPOSITIVE			  Near	 FLAT:034E
YROLPOSITIVE			  Near	 FLAT:024C

Structure Name			  Type	Offset

FLT
 FLTN				  Dword	 0000
 USEN				  Dword	 0004
 POSN				  Dword	 0008
 SUMX				  Dword	 000C
 SUMY				  Dword	 0010
 TOTX				  Dword	 0014
 TOTY				  Dword	 0018
 VALX				  Dword	 001C
 VALY				  Dword	 004C
SCR
 BTNEVNT			  Word	 0000
 YCURPOS			  Word	 0002
 XCURPOS			  Word	 0004
 YMAXPOS			  Word	 0006
 XMAXPOS			  Word	 0008
 XMAXOUT			  Dword	 000A
 YMAXOUT			  Dword	 000E
 XOUTPOS			  Dword	 0012
 YOUTPOS			  Dword	 0016
 ACTION0			  Word	 001A
 ACTION1			  Word	 001C
 ACTION2			  Word	 001E
 ACTION3			  Word	 0020
 ACTION4			  Word	 0022
 ACTION5			  Word	 0024
 ACTION6			  Word	 0026
 ACTION7			  Word	 0028
TBL
Turbo Assembler	 Version 4.1	    28-01-12 09:09:12	    Page 22
Symbol Table



 EVNTBT0			  Byte	 0000
 EVNTBT1			  Byte	 0001
 EVNTBT2			  Byte	 0002
 EVNTBT3			  Byte	 0003
 XMAXPOS			  Dword	 0004
 YMAXPOS			  Dword	 0008
 XMAXOUT			  Dword	 000C
 YMAXOUT			  Dword	 0010
 XMINOUT			  Dword	 0014
 YMINOUT			  Dword	 0018
 XNEWPOS			  Dword	 001C
 YNEWPOS			  Dword	 0020
 XOLDPOS			  Dword	 0024
 YOLDPOS			  Dword	 0028
 BUTTON1			  Word	 002C
 BUTTON2			  Word	 002E
 BUTTON3			  Word	 0030
 XMAX0				  Word	 0032
 YMAX0				  Word	 0034
 XMAX1				  Word	 0036
 YMAX1				  Word	 0038

Groups & Segments		  Bit Size Align  Combine Class

DGROUP				  Group
  STACK				  32  2000 Para	  Stack	  STACK
  _BSS				  32  001C Dword  Public  BSS
  _DATA				  32  0228 Dword  Public  DATA
FLAT				  Group
_TEXT				  32  062E Dword  Public  CODE
